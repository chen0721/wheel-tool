<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½‰ç›¤å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 1400px;
            width: 100%;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                max-width: 600px;
            }
        }

        h1 {
            grid-column: 1 / -1;
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 32px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .wheel-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 20px;
        }

        canvas {
            max-width: 100%;
            height: auto;
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.1));
        }

        .wheel-pin {
            position: absolute;
            top: -15px;
            font-size: 30px;
            z-index: 10;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }

        .section h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
            min-height: 120px;
        }

        .control-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            align-items: flex-end;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="number"],
        input[type="text"] {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            grid-column: 1 / -1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover {
            background: #ff5252;
        }

        .results-section {
            max-height: 400px;
            overflow-y: auto;
        }

        .result-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .result-number {
            font-weight: 600;
            color: #667eea;
            min-width: 30px;
        }

        .result-name {
            flex: 1;
            margin: 0 15px;
            color: #333;
        }

        .result-time {
            color: #999;
            font-size: 12px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }

        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .stat-label {
            color: #999;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #667eea;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-content input {
            width: 100%;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .color-picker {
            width: 100%;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* é€²éšåŠŸèƒ½é ç±¤æ¨£å¼ */
        .tabs-container {
            grid-column: 1 / -1;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tabs-header {
            display: flex;
            gap: 0;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: #f8f9fa;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 13px;
        }

        .tab-button:hover {
            background: #f0f1f3;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tabs-content {
            display: none;
            background: white;
            border-radius: 0 0 12px 12px;
            border: 1px solid #e0e0e0;
            border-top: none;
            padding: 20px;
            grid-column: 1 / -1;
        }

        .tabs-content.active {
            display: block;
        }

        .advanced-option {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .advanced-option:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .option-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-description {
            color: #999;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .audio-control {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .audio-control-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }

        .audio-control-row:last-child {
            margin-bottom: 0;
        }

        .audio-label {
            font-size: 12px;
            color: #666;
        }

        input[type="file"] {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .audio-button {
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .audio-button:hover {
            background: #f0f1f3;
        }

        .btn-reset-audio {
            padding: 8px 16px;
            background: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }

        .btn-reset-audio:hover {
            background: #d0d0d0;
        }

        .info-badge {
            display: inline-block;
            background: #fff3cd;
            color: #856404;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¡ è½‰ç›¤æŠ½ç±¤å·¥å…·</h1>

        <div class="left-panel">
            <!-- è½‰ç›¤ -->
            <div class="section">
                <div class="wheel-container">
                    <canvas id="wheel" width="300" height="300"></canvas>
                    <div class="wheel-pin">â–¼</div>
                </div>
            </div>

            <!-- é …ç›®ç·¨è¼¯ -->
            <div class="section">
                <h2>ç·¨è¼¯é …ç›®</h2>
                <textarea id="items" placeholder="æ¯è¡Œè¼¸å…¥ä¸€å€‹é …ç›®ï¼Œä¾‹å¦‚ï¼š&#10;å°æ˜&#10;å°ç´…&#10;å°ç¾&#10;..."></textarea>
                <button class="btn-primary" onclick="initWheel()">æ›´æ–°è½‰ç›¤</button>
            </div>
        </div>

        <div class="right-panel">
            <!-- æŠ½ç±¤æ§åˆ¶ -->
            <div class="section">
                <h2>æŠ½ç±¤è¨­ç½®</h2>
                <div class="control-group">
                    <div class="input-group">
                        <label>æŠ½ç±¤æ¬¡æ•¸ (1-99)</label>
                        <input type="number" id="times" min="1" max="99" value="1">
                    </div>
                    <button class="btn-primary" onclick="startAutoSpin()" style="grid-column: 1 / -1; margin-top: 8px;">é–‹å§‹è‡ªå‹•æŠ½ç±¤</button>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress"></div>
                </div>
                <div class="button-group" style="margin-top: 15px;">
                    <button class="btn-secondary" onclick="manualSpin()">æ‰‹å‹•æ—‹è½‰ä¸€æ¬¡</button>
                    <button class="btn-danger" onclick="clearResults()">æ¸…ç©ºçµæœ</button>
                </div>
                <div style="margin-top: 12px; padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <p style="font-size: 12px; color: #856404; margin-bottom: 10px;">
                        ğŸ’¡ <strong>é‡è¦æç¤º</strong>ï¼šè½‰ç›¤æœƒä¿ç•™æ—‹è½‰ä½ç½®ã€‚åªæœ‰åœ¨ä»¥ä¸‹æƒ…æ³æœƒé‡ç½®ï¼š
                        <ul style="margin: 5px 0 0 20px; padding: 0;">
                            <li>å•Ÿç”¨ã€ŒæŠ½é¸å¾Œç§»é™¤é …ç›®ã€ä¸¦é–‹å§‹æ–°é€±æœŸ</li>
                            <li>é»æ“Šä¸‹æ–¹ã€Œé‡è¨­è½‰ç›¤ã€æŒ‰éˆ•</li>
                        </ul>
                    </p>
                    <button class="btn-secondary" onclick="resetWheelPosition()" style="grid-column: 1 / -1; width: 100%; background: #ffc107; color: #333; margin-top: 8px;">ğŸ”„ é‡è¨­è½‰ç›¤ä½ç½®åˆ° 0Â°</button>
                </div>
            </div>

            <!-- çµ±è¨ˆæ•¸æ“š -->
            <div class="section">
                <h2>çµ±è¨ˆä¿¡æ¯</h2>
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-label">ç¸½æŠ½ç±¤æ¬¡æ•¸</div>
                        <div class="stat-value" id="total-count">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">é …ç›®æ•¸é‡</div>
                        <div class="stat-value" id="item-count">0</div>
                    </div>
                </div>
            </div>

            <!-- çµæœåˆ—è¡¨ -->
            <div class="section">
                <h2>æŠ½ç±¤çµæœ</h2>
                <div class="results-section" id="results">
                    <div class="empty-state">é‚„æ²’æœ‰æŠ½ç±¤çµæœ</div>
                </div>
            </div>

            <!-- é€²éšåŠŸèƒ½é ç±¤ -->
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-button" onclick="switchTab(0)">âš™ï¸ é€²éšåŠŸèƒ½</button>
                </div>
                
                <div class="tabs-content">
                    <!-- é¸é …1: ç§»é™¤å·²æŠ½ä¸­ -->
                    <div class="advanced-option">
                        <div class="option-title">
                            âœ‚ï¸ æŠ½é¸å¾Œç§»é™¤é …ç›®
                            <span class="info-badge">å¯¦é©—æ€§åŠŸèƒ½</span>
                        </div>
                        <div class="option-description">å•Ÿç”¨æ­¤é¸é …å¾Œï¼Œè¢«æŠ½ä¸­çš„é …ç›®å°‡å¾è½‰ç›¤ä¸­ç§»é™¤ï¼Œç›´åˆ°æ‚¨é‡ç½®åˆ—è¡¨</div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="removeSelected" onchange="updateAdvancedSettings()">
                            <label for="removeSelected">å•Ÿç”¨ç§»é™¤åŠŸèƒ½</label>
                        </div>
                    </div>

                    <!-- é¸é …2: è½‰ç›¤æ•ˆæœéŸ³ -->
                    <div class="advanced-option">
                        <div class="option-title">ğŸ”Š è½‰ç›¤æ•ˆæœéŸ³</div>
                        <div class="option-description">ç•¶è½‰ç›¤è·¨éé¸é …äº¤ç•Œé»æ™‚è§¸ç™¼</div>
                        <div class="audio-control">
                            <div class="audio-control-row">
                                <span class="audio-label">éŸ³æ•ˆæ–‡ä»¶</span>
                                <input type="file" id="wheelAudio" accept="audio/*" onchange="handleAudioUpload('wheelAudio')">
                            </div>
                            <div class="audio-control-row">
                                <button class="audio-button" onclick="playPreview('wheelAudio')">ğŸ”‰ è©¦è½</button>
                                <button class="audio-button" onclick="resetAudio('wheelAudio')">é‡ç½®</button>
                            </div>
                        </div>
                        <button class="btn-reset-audio" onclick="resetAllAudio('wheelAudio')">æ¢å¾©é è¨­å€¼</button>
                    </div>

                    <!-- é¸é …3: ä¸­çæ•ˆæœéŸ³ -->
                    <div class="advanced-option">
                        <div class="option-title">ğŸ‰ ä¸­çæ•ˆæœéŸ³</div>
                        <div class="option-description">è½‰ç›¤åœæ­¢å¾Œè§¸ç™¼ï¼ˆæ™®é€š/é€£æŠ½æ•ˆæœåˆ†é›¢ï¼‰</div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: 500; color: #555; margin-bottom: 8px; font-size: 13px;">æ™®é€šä¸­çéŸ³æ•ˆ</div>
                            <div class="audio-control">
                                <div class="audio-control-row">
                                    <span class="audio-label">éŸ³æ•ˆæ–‡ä»¶</span>
                                    <input type="file" id="normalWinAudio" accept="audio/*" onchange="handleAudioUpload('normalWinAudio')">
                                </div>
                                <div class="audio-control-row">
                                    <button class="audio-button" onclick="playPreview('normalWinAudio')">ğŸ”‰ è©¦è½</button>
                                    <button class="audio-button" onclick="resetAudio('normalWinAudio')">é‡ç½®</button>
                                </div>
                            </div>
                            <button class="btn-reset-audio" onclick="resetAllAudio('normalWinAudio')">æ¢å¾©é è¨­å€¼</button>
                        </div>

                        <div>
                            <div style="font-weight: 500; color: #555; margin-bottom: 8px; font-size: 13px;">é€£æŠ½æœ€å¾Œä¸­çéŸ³æ•ˆ <span class="info-badge">ç‰¹æ®Š</span></div>
                            <div class="audio-control">
                                <div class="audio-control-row">
                                    <span class="audio-label">éŸ³æ•ˆæ–‡ä»¶</span>
                                    <input type="file" id="bonusWinAudio" accept="audio/*" onchange="handleAudioUpload('bonusWinAudio')">
                                </div>
                                <div class="audio-control-row">
                                    <button class="audio-button" onclick="playPreview('bonusWinAudio')">ğŸ”‰ è©¦è½</button>
                                    <button class="audio-button" onclick="resetAudio('bonusWinAudio')">é‡ç½®</button>
                                </div>
                            </div>
                            <button class="btn-reset-audio" onclick="resetAllAudio('bonusWinAudio')">æ¢å¾©é è¨­å€¼</button>
                        </div>
                    </div>

                    <!-- é¸é …4: èƒŒæ™¯æ¨‚ -->
                    <div class="advanced-option">
                        <div class="option-title">ğŸµ èƒŒæ™¯æ¨‚</div>
                        <div class="option-description">å¾ªç’°æ’­æ”¾ï¼Œè½‰ç›¤æ—‹è½‰æ™‚æ’­æ”¾</div>
                        <div class="audio-control">
                            <div class="audio-control-row">
                                <span class="audio-label">éŸ³æ•ˆæ–‡ä»¶</span>
                                <input type="file" id="bgmAudio" accept="audio/*" onchange="handleAudioUpload('bgmAudio')">
                            </div>
                            <div class="audio-control-row">
                                <button class="audio-button" onclick="playPreview('bgmAudio')">ğŸ”‰ è©¦è½</button>
                                <button class="audio-button" onclick="resetAudio('bgmAudio')">é‡ç½®</button>
                            </div>
                            <div style="margin-top: 10px;">
                                <input type="checkbox" id="bgmEnabled" onchange="updateAdvancedSettings()">
                                <label for="bgmEnabled">å•Ÿç”¨èƒŒæ™¯æ¨‚</label>
                            </div>
                        </div>
                        <button class="btn-reset-audio" onclick="resetAllAudio('bgmAudio')">æ¢å¾©é è¨­å€¼</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šæ•¸
        let items = ['å°æ˜', 'å°ç´…', 'å°ç¾', 'å°ç‹', 'å°æ'];
        let originalItems = [...items]; // ä¿å­˜åŸå§‹åˆ—è¡¨
        let colors = [];
        let results = [];
        let isSpinning = false;
        let currentRotation = 0;
        let currentSpinCount = 0;
        let totalSpinCount = 0;

        // éŸ³é »ç‰©ä»¶
        const audioElements = {
            wheel: new Audio(),
            normalWin: new Audio(),
            bonusWin: new Audio(),
            bgm: new Audio()
        };

        // éŸ³é »é è¨­å€¼
        const defaultAudioPaths = {
            wheel: 'Wheel Tool Sound/Wheel Tool Sound.wav',
            normalWin: 'Wheel Tool Sound/Success Ding.wav',
            bonusWin: 'Wheel Tool Sound/Bonus Win.mp3',
            bgm: 'Wheel Tool Sound/Wheel Background Music.wav'
        };

        // é è¨­éŸ³æª” Base64 ç·¨ç¢¼ï¼ˆå°å‹éŸ³æª”ï¼‰
        const defaultAudioBase64 = {
            wheel: null,  // å°‡åœ¨åˆå§‹åŒ–æ™‚å¾æ–‡ä»¶åŠ è¼‰
            normalWin: null,
            bonusWin: null,
            bgm: null
        };

        // é€²éšè¨­ç½®
        let advancedSettings = {
            removeSelected: false,
            bgmEnabled: false,
            wheelAudioEnabled: true,
            winAudioEnabled: true
        };

        // åˆå§‹åŒ–é¡è‰²
        function generateColors(count) {
            const hues = [];
            for (let i = 0; i < count; i++) {
                hues.push((i * 360) / count);
            }
            return hues.map(hue => `hsl(${hue}, 70%, 50%)`);
        }

        // åˆ‡æ›é€²éšåŠŸèƒ½é ç±¤
        function switchTab(tabIndex) {
            const buttons = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tabs-content');
            
            buttons.forEach((btn, idx) => {
                btn.classList.toggle('active', idx === tabIndex);
            });
            
            contents.forEach((content, idx) => {
                content.classList.toggle('active', idx === tabIndex);
            });
        }

        // åˆå§‹åŒ–è½‰ç›¤
        function initWheel() {
            const textarea = document.getElementById('items');
            const newItems = textarea.value
                .split('\n')
                .map(item => item.trim())
                .filter(item => item.length > 0);

            if (newItems.length === 0) {
                alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹é …ç›®');
                return;
            }

            if (newItems.length > 99) {
                alert('é …ç›®æ•¸é‡ä¸èƒ½è¶…é99å€‹');
                return;
            }

            items = newItems;
            originalItems = [...items]; // ä¿å­˜åŸå§‹åˆ—è¡¨
            colors = generateColors(items.length);
            document.getElementById('item-count').textContent = items.length;
            drawWheel();
        }

        // ç¹ªè£½è½‰ç›¤
        function drawWheel() {
            const canvas = document.getElementById('wheel');
            const ctx = canvas.getContext('2d');
            const radius = canvas.width / 2;
            const sliceAngle = (Math.PI * 2) / items.length;

            // æ¸…ç©ºç•«å¸ƒ
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ä¿å­˜ç•¶å‰æ—‹è½‰è§’åº¦
            ctx.save();
            ctx.translate(radius, radius);
            ctx.rotate(currentRotation);

            // ç¹ªè£½æ‰‡å½¢
            for (let i = 0; i < items.length; i++) {
                const startAngle = i * sliceAngle;
                const endAngle = (i + 1) * sliceAngle;

                // ç¹ªè£½æ‰‡å½¢
                ctx.fillStyle = colors[i];
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radius * 0.9, startAngle, endAngle);
                ctx.closePath();
                ctx.fill();

                // ç¹ªè£½é‚Šæ¡†
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();

                // ç¹ªè£½æ–‡å­—
                ctx.save();
                ctx.rotate(startAngle + sliceAngle / 2);
                ctx.textAlign = 'right';
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Arial';
                ctx.fillText(items[i], radius * 0.75, 5);
                ctx.restore();
            }

            // ç¹ªè£½ä¸­å¿ƒåœ“
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(0, 0, radius * 0.15, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();

            // ç¹ªè£½é‚Šæ¡†åœ“
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(radius, radius, radius * 0.9, 0, Math.PI * 2);
            ctx.stroke();
        }

        // æ—‹è½‰è½‰ç›¤
        // è½‰ç›¤æœƒè¨˜æ†¶ä¸Šæ¬¡åœæ­¢çš„ä½ç½®ï¼Œä¸‹ä¸€è¼ªæ—‹è½‰æœƒå¾è©²ä½ç½®é–‹å§‹è½‰å‹•
        function spinWheel(duration = 3000, targetIndex = null, isLastSpin = false) {
            if (items.length === 0) {
                alert('è«‹å…ˆè¼¸å…¥é …ç›®');
                return null;
            }

            if (isSpinning) {
                return null;
            }

            isSpinning = true;
            let lastAngle = 0;

            // éš¨æ©Ÿé¸æ“‡çµæœ
            if (targetIndex === null) {
                targetIndex = Math.floor(Math.random() * items.length);
            }

            // è¨ˆç®—ç›®æ¨™è§’åº¦
            const sliceAngle = (Math.PI * 2) / items.length;
            const targetAngle = -(targetIndex * sliceAngle + sliceAngle / 2) + Math.PI / 2;

            // æ’­æ”¾èƒŒæ™¯æ¨‚
            if (advancedSettings.bgmEnabled && !audioElements.bgm.playing) {
                audioElements.bgm.loop = true;
                audioElements.bgm.play().catch(() => {});
            }

            // åŸ·è¡Œæ—‹è½‰å‹•ç•«
            const startRotation = currentRotation;
            const startTime = Date.now();
            const rotations = 5 + Math.random() * 3;

            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // ä½¿ç”¨ç·©å‹•å‡½æ•¸
                const easeProgress = 1 - Math.pow(1 - progress, 3);

                // è¨ˆç®—æ—‹è½‰è§’åº¦
                currentRotation = startRotation + (rotations * Math.PI * 2 + targetAngle - startRotation) * easeProgress;

                // è§¸ç™¼è½‰ç›¤æ•ˆæœéŸ³
                if (advancedSettings.wheelAudioEnabled && audioElements.wheel.src) {
                    const currentAngle = currentRotation % (Math.PI * 2);
                    const segmentAngle = (Math.PI * 2) / items.length;
                    
                    if (Math.abs(currentAngle - lastAngle) > segmentAngle * 0.5) {
                        audioElements.wheel.currentTime = 0;
                        audioElements.wheel.play().catch(() => {});
                        lastAngle = currentAngle;
                    }
                }

                drawWheel();

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    isSpinning = false;
                    // è½‰ç›¤åœæ­¢åœ¨ç›®æ¨™ä½ç½®ï¼Œä¿ç•™æ­¤ä½ç½®ä¾›ä¸‹ä¸€è¼ªæ—‹è½‰ä½¿ç”¨
                    currentRotation = targetAngle;
                    drawWheel();
                    
                    // ä¿å­˜ç•¶å‰ä½ç½®ï¼Œä»¥é˜²è¢«æ„å¤–ä¿®æ”¹
                    const savedRotation = currentRotation;

                    // æ’­æ”¾ä¸­çéŸ³æ•ˆ
                    setTimeout(() => {
                        // ç¢ºä¿è§’åº¦æ²’æœ‰è¢«ä¿®æ”¹
                        currentRotation = savedRotation;
                        
                        if (advancedSettings.winAudioEnabled) {
                            if (isLastSpin && audioElements.bonusWin.src) {
                                audioElements.bonusWin.currentTime = 0;
                                audioElements.bonusWin.play().catch(() => {});
                            } else if (audioElements.normalWin.src) {
                                audioElements.normalWin.currentTime = 0;
                                audioElements.normalWin.play().catch(() => {});
                            }
                        }

                        addResult(items[targetIndex]);

                        // ç§»é™¤å·²æŠ½ä¸­çš„é …ç›®
                        if (advancedSettings.removeSelected) {
                            items.splice(targetIndex, 1);
                            colors = generateColors(items.length);
                            document.getElementById('item-count').textContent = items.length;
                            // é‡è¦ï¼šä¿æŒç•¶å‰çš„è½‰ç›¤è§’åº¦ï¼Œåªé‡ç¹ªé …ç›®è®ŠåŒ–
                            drawWheel();
                        }
                    }, 200);
                }
            }

            animate();
            return targetIndex;
        }

        // æ‰‹å‹•æ—‹è½‰ä¸€æ¬¡
        function manualSpin() {
            spinWheel(3000, null, false);
        }

        // è‡ªå‹•æŠ½ç±¤
        function startAutoSpin() {
            if (items.length === 0) {
                alert('è«‹å…ˆè¼¸å…¥é …ç›®');
                return;
            }

            const times = parseInt(document.getElementById('times').value) || 1;

            if (times < 1 || times > 99) {
                alert('æŠ½ç±¤æ¬¡æ•¸å¿…é ˆåœ¨1-99ä¹‹é–“');
                return;
            }

            // åªæœ‰åœ¨å•Ÿç”¨ç§»é™¤åŠŸèƒ½æ™‚ï¼Œæ‰é‡ç½®é …ç›®åˆ—è¡¨å’Œè½‰ç›¤ä½ç½®
            // é€™æ¨£åšæ˜¯å› ç‚ºç§»é™¤åŠŸèƒ½æœƒæ”¹è®Šè½‰ç›¤çš„é …ç›®æ•¸é‡ï¼Œå¿…é ˆé‡æ–°é–‹å§‹
            if (advancedSettings.removeSelected) {
                items = [...originalItems];
                colors = generateColors(items.length);
                document.getElementById('item-count').textContent = items.length;
                currentRotation = 0; // é‡ç½®è½‰ç›¤ä½ç½®åˆ°åˆå§‹ç‹€æ…‹ï¼ˆæ–°é€±æœŸï¼‰
                drawWheel();
                // æ¸…ç©ºä¹‹å‰çš„çµæœ
                results = [];
                displayResults();
                document.getElementById('total-count').textContent = '0';
                document.getElementById('progress').style.width = '0%';
            } else {
                // å¦‚æœä¸ä½¿ç”¨ç§»é™¤åŠŸèƒ½ï¼Œä¿æŒè½‰ç›¤è§’åº¦ï¼Œåªæ¸…ç©ºçµæœ
                results = [];
                displayResults();
                document.getElementById('total-count').textContent = '0';
                document.getElementById('progress').style.width = '0%';
            }

            currentSpinCount = 0;
            totalSpinCount = times;
            spinMultipleTimes(times);
        }

        // é€£çºŒæ—‹è½‰å¤šæ¬¡
        function spinMultipleTimes(count, index = 0) {
            if (index >= count) {
                // åœæ­¢èƒŒæ™¯æ¨‚
                if (audioElements.bgm) {
                    audioElements.bgm.pause();
                    audioElements.bgm.currentTime = 0;
                }
                return;
            }

            currentSpinCount = index + 1;
            const duration = index === count - 1 ? 3000 : 2000;
            const isLastSpin = index === count - 1;
            spinWheel(duration, null, isLastSpin);

            setTimeout(() => {
                spinMultipleTimes(count, index + 1);
                updateProgress((index + 1) / count);
            }, duration + 100);
        }

        // æ·»åŠ çµæœ
        function addResult(item) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-Hant');
            results.push({ item, time: timeStr, index: results.length + 1 });

            displayResults();
            document.getElementById('total-count').textContent = results.length;
        }

        // é¡¯ç¤ºçµæœåˆ—è¡¨
        function displayResults() {
            const resultsDiv = document.getElementById('results');

            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="empty-state">é‚„æ²’æœ‰æŠ½ç±¤çµæœ</div>';
                return;
            }

            resultsDiv.innerHTML = results
                .map(
                    result => `
                <div class="result-item">
                    <span class="result-number">#${result.index}</span>
                    <span class="result-name">${result.item}</span>
                    <span class="result-time">${result.time}</span>
                </div>
            `
                )
                .join('');

            // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // æ›´æ–°é€²åº¦æ¢
        function updateProgress(progress) {
            document.getElementById('progress').style.width = progress * 100 + '%';
        }

        // æ¸…ç©ºçµæœ
        function clearResults() {
            if (results.length > 0 && confirm('ç¢ºèªæ¸…ç©ºæ‰€æœ‰çµæœï¼Ÿ')) {
                results = [];
                displayResults();
                document.getElementById('total-count').textContent = '0';
                document.getElementById('progress').style.width = '0%';
                // é‡è¦ï¼šæ¸…ç©ºçµæœæ™‚ä¸é‡ç½®è½‰ç›¤ä½ç½®
            }
        }

        // é‡ç½®è½‰ç›¤ä½ç½®
        function resetWheelPosition() {
            if (!isSpinning) {
                currentRotation = 0;
                drawWheel();
            }
        }

        // éŸ³é »è™•ç†å‡½æ•¸
        function handleAudioUpload(elementId) {
            const input = document.getElementById(elementId);
            const file = input.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const audioKey = getAudioKey(elementId);
                    audioElements[audioKey].src = e.target.result;
                    localStorage.setItem(`wheelTool_${elementId}`, e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function getAudioKey(elementId) {
            const mapping = {
                'wheelAudio': 'wheel',
                'normalWinAudio': 'normalWin',
                'bonusWinAudio': 'bonusWin',
                'bgmAudio': 'bgm'
            };
            return mapping[elementId] || 'wheel';
        }

        function playPreview(elementId) {
            const audioKey = getAudioKey(elementId);
            const audio = audioElements[audioKey];
            if (audio.src) {
                audio.currentTime = 0;
                audio.play().catch(() => {});
            }
        }

        function resetAudio(elementId) {
            const input = document.getElementById(elementId);
            input.value = '';
            const audioKey = getAudioKey(elementId);
            audioElements[audioKey].src = '';
            localStorage.removeItem(`wheelTool_${elementId}`);
        }

        function resetAllAudio(elementId) {
            resetAudio(elementId);
            // å˜—è©¦å¾é è¨­è·¯å¾‘åŠ è¼‰
            const audioKey = getAudioKey(elementId);
            const defaultPath = defaultAudioPaths[audioKey];
            if (defaultPath) {
                loadAudioFromPath(defaultPath, audioKey);
            }
        }

        function loadAudioFromPath(path, audioKey) {
            // æ”¯æŒç›¸å°è·¯å¾‘å’Œçµ•å°è·¯å¾‘
            const audio = audioElements[audioKey];
            
            // é¦–å…ˆå˜—è©¦ä½¿ç”¨ fetch API
            fetch(path)
                .then(response => {
                    if (!response.ok) throw new Error(`Failed to load: ${path}`);
                    return response.blob();
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    audio.src = url;
                    // åŒæ™‚ä¿å­˜åˆ° localStorage
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const elementId = Object.keys(defaultAudioPaths).indexOf(audioKey) >= 0 
                            ? getElementId(audioKey) 
                            : null;
                        if (elementId) {
                            localStorage.setItem(`wheelTool_${elementId}`, e.target.result);
                        }
                    };
                    reader.readAsDataURL(blob);
                })
                .catch(error => {
                    console.log(`ç„¡æ³•åŠ è¼‰éŸ³æª”: ${path}`);
                    // å˜—è©¦ç›´æ¥è¨­ç½®è·¯å¾‘ï¼ˆç”¨æ–¼æŸäº›ç€è¦½å™¨ï¼‰
                    audio.src = path;
                });
        }

        function getElementId(audioKey) {
            const mapping = {
                'wheel': 'wheelAudio',
                'normalWin': 'normalWinAudio',
                'bonusWin': 'bonusWinAudio',
                'bgm': 'bgmAudio'
            };
            return mapping[audioKey];
        }

        function updateAdvancedSettings() {
            advancedSettings.removeSelected = document.getElementById('removeSelected').checked;
            advancedSettings.bgmEnabled = document.getElementById('bgmEnabled').checked;
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('items').value = items.join('\n');
            colors = generateColors(items.length);
            document.getElementById('item-count').textContent = items.length;
            drawWheel();

            // è‡ªå‹•åŠ è¼‰é è¨­éŸ³æª”
            Object.entries(defaultAudioPaths).forEach(([key, path]) => {
                loadAudioFromPath(path, key);
            });

            // å¿«æ·éµ
            document.addEventListener('keydown', event => {
                if (event.code === 'Space') {
                    event.preventDefault();
                    manualSpin();
                }
                if (event.code === 'KeyR') {
                    event.preventDefault();
                    startAutoSpin();
                }
                if (event.code === 'KeyC') {
                    event.preventDefault();
                    clearResults();
                }
            });
        });

        // éŸ¿æ‡‰å¼è¨­è¨ˆ - é‡æ–°ç¹ªè£½
        window.addEventListener('resize', () => {
            drawWheel();
        });
    </script>
</body>
</html>
